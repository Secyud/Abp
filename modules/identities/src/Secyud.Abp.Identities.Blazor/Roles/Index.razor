
@using Secyud.Abp.ObjectExtending
@using Secyud.Abp.Permissions.Components
@inherits AbpCrudPageBase<Secyud.Abp.Identities.IIdentityRoleAppService, Secyud.Abp.Identities.IdentityRoleDto, Guid, Secyud.Abp.Identities.GetIdentityRoleListInput, Secyud.Abp.Identities.IdentityRoleCreateDto, Secyud.Abp.Identities.IdentityRoleUpdateDto>
@* ************************* PAGE HEADER ************************* *@
<SCard>
    <Header>
        <STitle>
            @L["Roles"]
        </STitle>

        @if (HasCreatePermission)
        {
            <Button Click="OpenCreateModalAsync">
                <SIcon IconName="IconName.Create"/>
                @L["NewRole"]
            </Button>
        }
    </Header>
</SCard>

@* ************************* SEARCH ************************* *@
<SCard>
    <Body>

    <div class="group" style="grid-template-columns: 1fr var(--u)">
        <TextBox Class="l" placeholder="@L["Search"]" @bind-Value="GetListInput.Filter"/>
        <SIcon Class="anim r" IconName="IconName.Search" Click="SearchEntitiesAsync"/>
    </div>
    </Body>
</SCard>

@* ************************* DATA GRID ************************* *@
<SCard>
    <Body>
    <SGrid @ref="View" TValue="IdentityRoleDto">
        <EnableDynamicSource Items="GetEntitiesAsync"/>
        <EnableIteratorPager/>
        <EnableColumnResize/>

        <GridColumn Field="u => u.Id" Caption="@L["Actions"]">
            <ColumnTemplate>
                <DropdownBox>
                    <ChildContent>
                        @L["Actions"]
                    </ChildContent>
                    <DropdownContentTemplate>
                        @if (HasUpdatePermission)
                        {
                            <Button Click="@(() => OpenUpdateModalAsync(context))">
                                @L["Update"]
                            </Button>
                        }
                        @if (HasManagePermissionsPermission)
                        {
                            <Button Click="@(() => PermissionsGrantModal.OpenAsync(
                                               PermissionProviderName, context.Name, context.Name))">
                                @L["Permissions"]
                            </Button>
                        }
                        @if (HasDeletePermission)
                        {
                            <Button Click="@(() => OpenDeleteModalAsync(context))">
                                @L["Delete"]
                            </Button>
                        }
                        @if (HasUpdatePermission)
                        {
                            <Button Click="@(() => OpenMoveAllUsersModalAsync(context))">
                                @L["MoveAllUsers"]
                            </Button>
                        }
                    </DropdownContentTemplate>
                </DropdownBox>
            </ColumnTemplate>
        </GridColumn>
        <GridColumn Field="u => u.Name" Caption="@L["RoleName"]" EnableSorter>
            <ColumnTemplate>
                @(context.Name)
                @if (context.IsDefault)
                {
                    <div class="badge success colored">
                        @L["DisplayName:IsDefault"]
                    </div>
                }
                @if (context.IsPublic)
                {
                    <div class="badge success colored">
                        @L["DisplayName:IsPublic"]
                    </div>
                }
            </ColumnTemplate>
        </GridColumn>
        <GridColumn Field="u => u.UserCount" Caption="@L["UserCount"]" EnableSorter/>
        <ExtensionTableColumns ModuleName="@IdentityModuleExtensionConsts.ModuleName"
                               EntityName="@IdentityModuleExtensionConsts.EntityNames.Role"/>
    </SGrid>
    </Body>
</SCard>

@* ************************* CREATE MODAL ************************* *@
@if (HasCreatePermission)
{
    <SModal @ref="CreateModal">
        <SCard>
            <Header>
                <STitle>
                    @L["NewRole"]
                </STitle>
                <CloseButton Click="CloseCreateModalAsync"/>
            </Header>
            <Body>
            <SFormLayout EnableValidation ParentValidationForm>

                <FormLayoutItem Title="@($"{L["DisplayName:RoleName"]} *")" ShowValidationMessage>
                    <TextBox @bind-Value="@CreateEntity.Name"/>
                </FormLayoutItem>
                <FormLayoutItem Title="@L["DisplayName:IsDefault"]">
                    <CheckBox @bind-Value="CreateEntity.IsDefault"></CheckBox>
                </FormLayoutItem>
                <FormLayoutItem Title="@L["DisplayName:IsPublic"]">
                    <CheckBox @bind-Value="CreateEntity.IsPublic"></CheckBox>
                </FormLayoutItem>

                <ExtensionProperties
                    Entity="@CreateEntity" Localizer="L"
                    ModalType="ExtensionPropertyModalType.CreateModal"/>
            </SFormLayout>
            </Body>
            <Footer>
                <CancelButton Click="CloseCreateModalAsync"/>
                <SubmitButton Click="CreateEntityAsync"/>
            </Footer>
        </SCard>
    </SModal>
}

@* ************************* EDIT MODAL ************************* *@
@if (HasUpdatePermission)
{
    <SModal @ref="UpdateModal">
        <SCard Centered="true">
            <Header>
                <STitle>
                    @L["Edit"] - @UpdateEntity.Name
                </STitle>
                <CloseButton Click="CloseUpdateModalAsync"/>
            </Header>
            <Body>
            <SFormLayout EnableValidation ParentValidationForm>
                <input type="hidden" name="ConcurrencyStamp" @bind-value="UpdateEntity.ConcurrencyStamp"/>
                <FormLayoutItem Title="@($"{L["DisplayName:RoleName"]} *")" ShowValidationMessage>
                    <TextBox @bind-Value="@UpdateEntity.Name" ReadOnly="@_updateRoleIsStatic"/>
                    <p>@L["{0}IsStaticRoleCanNotBeRenamed", UpdateEntity.Name]</p>
                </FormLayoutItem>
                <FormLayoutItem Title="@L["DisplayName:IsDefault"]">
                    <CheckBox @bind-Value="UpdateEntity.IsDefault"></CheckBox>
                </FormLayoutItem>
                <FormLayoutItem Title="@L["DisplayName:IsPublic"]">
                    <CheckBox @bind-Value="UpdateEntity.IsPublic"></CheckBox>
                </FormLayoutItem>
                <ExtensionProperties
                    Entity="@UpdateEntity" Localizer="L"
                    ModalType="ExtensionPropertyModalType.UpdateModal"/>
            </SFormLayout>
            </Body>
            <Footer>
                <CancelButton Click="CloseUpdateModalAsync"/>
                <SubmitButton Click="UpdateEntityAsync"/>
            </Footer>
        </SCard>
    </SModal>
}

@* ************************* DELETE MODAL ************************* *@
@if (HasDeletePermission)
{
    <SModal @ref="DeleteModal">
        <SCard>
            <Header>
                <STitle>
                    @L["AreYouSure"]
                </STitle>
                <CloseButton Click="CloseDeleteModalAsync"/>
            </Header>
            <Body>
            <p class="fw-bold">@L["RoleDeletionConfirmationMessage", DeletingRole.Name]</p>
            @if (DeletingRole.UserCount > 0)
            {
                <p class="mt-2">@L["ChooseAnActionForRole", DeletingRole.UserCount]</p>
                <SInput TValue="bool">
                    <EnableValueInput TValue="bool" Value="DeletingRole.AssignRole" ValueChanged="AssignCheckedChanged"/>
                    <AddRadio Value="false" Text="@L["UnassignTheRoleFromTheUsers"]"/>
                    @if (DeletingRole.OtherRoles.Any())
                    {
                        <AddRadio Value="true" Text="@L["AssignToOtherRole"]"/>
                    }
                </SInput>

                @if (DeletingRole.AssignRole)
                {
                    <ComboBox TValue="IdentityRoleDto" TField="Guid?"
                              Field="DeletingRole.AssignToRoleId" EnableNullable
                              FieldChanged="OnAssignToRoleSelectedValueChanged"
                              Items="DeletingRole.OtherRoles" ValueField="u => u.Id">
                        <ListItemTemplate>
                            @context.Name
                        </ListItemTemplate>
                    </ComboBox>
                }
            }

            </Body>
            <Footer>
                <CancelButton Theme="Theme.Danger" Click="CloseUpdateModalAsync"/>
                <SButton Theme="Theme.Danger" Click="DeleteRoleAsync">
                    <AddTemplate>
                        <SIcon IconName="IconName.Delete"/>
                        @L["Delete"]
                    </AddTemplate>
                </SButton>
            </Footer>
        </SCard>
    </SModal>
}

@if (HasManagePermissionsPermission)
{
    <PermissionsGrantModal @ref="PermissionsGrantModal"/>
}

@* ************************* MOVE ALL Users MODAL ************************* *@
@if (HasUpdatePermission)
{
    <SModal @ref="MoveAllUsersModal">
        <SCard>
            <Header>
                <STitle>
                    @L["MoveAllUsers"] - @MoveAllUsersModel.CurrentRoleName
                </STitle>
                <CloseButton Click="CloseMoveAllUsersModalAsync"/>
            </Header>
            <Body>
            <p>@((MarkupString)L["MoveAllUsersWithRoleTo", MoveAllUsersModel.CurrentRoleName].ToString())</p>

            <ComboBox TValue="IdentityRoleDto" TField="Guid?"
                      @bind-Field="MoveAllUsersModel.TargetRoleId" EnableNullable
                      Items="MoveAllUsersModel.TargetRoles" ValueField="u => u.Id">
                <ListItemTemplate>
                    @context.Name
                </ListItemTemplate>
            </ComboBox>

            </Body>
            <Footer>
                <Button Theme="Theme.Primary" Class="outline" Click="CloseMoveAllUsersModalAsync">
                    @L["Cancel"]
                </Button>
                <SubmitButton Click="@MoveAllUsersAsync"/>
            </Footer>
        </SCard>
    </SModal>
}
